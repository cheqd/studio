version: '3'
services:
  cheqd-ledger:
    image: ghcr.io/cheqd/cheqd-node:production-latest
    platform: linux/amd64
    ports:
      - '26657:26657'
    command: >
      /bin/bash -c '
      cheqd-noded init "validator-node" --chain-id "testnet" --home "/tmp/.single-node" &&
      (echo "12345678") | cheqd-noded keys add validator --keyring-backend test --home "/tmp/.single-node" &&
      cheqd-noded genesis add-genesis-account $(cheqd-noded keys show validator -a --keyring-backend test --home "/tmp/.single-node") 100000000000000000ncheq --home "/tmp/.single-node" &&
      cheqd-noded genesis gentx validator 5000000000000000ncheq --chain-id testnet --keyring-backend test --home "/tmp/.single-node" &&
      cheqd-noded genesis collect-gentxs --home "/tmp/.single-node" &&
      sed -i 's/"stake"/"ncheq"/' "/tmp/.single-node/config/genesis.json" &&
      sed -i "s/minimum-gas-prices = \"\"/minimum-gas-prices = \"50ncheq\"/g" "/tmp/.single-node/config/app.toml" &&
      sed -i "s/enable = false/enable = true/g" "/tmp/.single-node/config/app.toml" &&
      sed -i "s|laddr = \"tcp://127.0.0.1:26657\"|laddr = \"tcp://0.0.0.0:26657\"|g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s|addr_book_strict = true|addr_book_strict = false|g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s/timeout_propose = \"3s\"/timeout_propose = \"500ms\"/g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s/timeout_prevote = \"1s\"/timeout_prevote = \"500ms\"/g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s/timeout_precommit = \"1s\"/timeout_precommit = \"500ms\"/g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s/timeout_commit = \"5s\"/timeout_commit = \"500ms\"/g" "/tmp/.single-node/config/config.toml" &&
      sed -i "s/log_level = \"info\"/log_level = \"debug\"/g" "/tmp/.single-node/config/config.toml" &&
      cheqd-noded start --home "/tmp/.single-node" &
      RUN_TESTNET_PID=$! &&
      sleep 10 &&
      (echo "12345678") | cheqd-noded tx bank send $(cheqd-noded keys show validator -a --keyring-backend test --home "/tmp/.single-node") cheqd1ua04gpwzmw0558ds8mq35kaacwu6jmy007t6mz 10000000000000000ncheq --from validator --gas auto --gas-adjustment=1.8 --fees 10000000000ncheq --chain-id testnet --keyring-backend test --home "/tmp/.single-node" -y &&
      wait $RUN_TESTNET_PID;
      ' 